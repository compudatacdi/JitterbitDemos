global class CDIEpicorPricing_apex { 

    public static Map<String, String> epicorPartData = new Map<String, String>();
    public static Map<String, String> epicorPricingData = new Map<String, String>();

    //poc method for async
    //https://salesforce.stackexchange.com/questions/299060/how-to-get-return-value-from-helper-class-to-controller-class
    @AuraEnabled  //needed to be able to call it from the aura realm
    public static String apexCreateRecord(String strPart) {
		
        //String strReturnValue = 'test';
        String strReturnValue = strPart;
        
        return strReturnValue;
        
    }
	
    @AuraEnabled  //needed to be able to call it from the aura realm    
    public static string getOpportunityLineItemProductCode(string opportunityLineItemID) {
        String strOpportunityLineItemProductCode = '';
        
        //get the related sf opportunity line item record from the id
        OpportunityLineItem[] opportunityLineItem;
        opportunityLineItem = [SELECT Id,ProductCode FROM OpportunityLineItem WHERE Id = :opportunityLineItemID];
        for (OpportunityLineItem row : opportunityLineItem) {
            strOpportunityLineItemProductCode = row.ProductCode;
        }
        
        return strOpportunityLineItemProductCode;

    } 
    
    @AuraEnabled  //needed to be able to call it from the aura realm     
    public static Map<String, String> getEpicorPart(string strPart) {

        String url = 'callout:CDI_Epicor/Erp.BO.PartSvc/Parts(\'PI03\',\'' + strPart.replace(' ', '%20') + '\')';
        
		try {
            //NOTE: if connection to epicor fails, this crashes hard, the catch never executes, 
            //		and return of variable never happens
            
            // Instantiate a new HTTP request, specify the method (GET) as well as the endpoint
            HttpRequest req = new HttpRequest();
            req.setEndpoint(url);
            req.setMethod('GET');

			//epicorPricingData.put('debugInfo', 'x: ' + opportunityLineItemID + ' / ' + strPart + ' / '  + intQuantity + ' / '  + strUOM + ' / '  + strCustID);
            
            Http h = new Http();            
            HttpResponse res = h.send(req);
            System.debug(res.getBody());

            JSONParser parser = JSON.createParser(res.getBody());
            //NOTE:  if epicor is down, this is where it fails because parser is empty:
    
            while (parser.nextToken() != null) {
                if ((parser.getCurrentToken() == JSONToken.FIELD_NAME) && 
                    (parser.getText() == 'PartNum'
                     || parser.getText() == 'PUM')) 
                {
                    string fieldName = parser.getText();
                    
                    parser.nextToken();
                                        
                    string fieldValue; 
                    if(fieldName == '<currency field>')
                    {
                        //fieldValue = String.valueOf(decimal.valueOf(parser.getText()));
                        fieldValue = currency(parser.getText());
                    }
                    else
                    {
                        fieldValue = parser.getText();
                    }
                    
                    epicorPartData.put(fieldName, fieldValue);
 
                    //KEEP: for debugging, to add debug log info
                    //System.debug('url_result: ' + url_result );
                    
                    epicorPartData.put('Epicor_Status', 'OK');
                    
                }
            }
        } catch (DmlException de) {
            epicorPartData.put('Epicor_Status', 'Epicor Error: ' + de );
        }
        catch (Exception e) {
            epicorPartData.put('Epicor_Status', 'Epicor Error: ' + e );
        }

        return epicorPartData;

    }
    
    
    @AuraEnabled  //needed to be able to call it from the aura realm    
    public static Map<String, String> getEpicorPricing(string opportunityLineItemID, string strPart, integer intQuantity, string strUOM, string strCustID) {
        
        String strReturnValue = 'apex';
        String url = 'callout:CDI_Epicor/Erp.BO.PriceListInquirySvc/GetPriceListInquiry';

		try {
            //NOTE: if connection to epicor fails, this crashes hard, the catch never executes, 
            //		and return of variable never happens
            
            // Instantiate a new HTTP request, specify the method (GET) as well as the endpoint
            HttpRequest req = new HttpRequest();
            req.setEndpoint(url);
            req.setMethod('POST');

			//epicorPricingData.put('debugInfo', 'x: ' + opportunityLineItemID + ' / ' + strPart + ' / '  + intQuantity + ' / '  + strUOM + ' / '  + strCustID);
            
            Http h = new Http();

            String body = 
                '        { ' +
                '            "icCustID": "' + strCustID + '", ' +
                '            "icShipToNum": "", ' +
                '            "icPartNum": "' + strPart + '", ' +
                '            "icCustGroupCode": "", ' +
                '            "icProductCode": "", ' +
                '            "idQuantity": "' + intQuantity + '", ' +
                '            "icUOMCode": "' + strUOM + '", ' +
                '            "icWarehouseCode": "", ' +
                '            "icCurrencyCode": "", ' +
                '            "pageSize": 0, ' +
                '            "absolutePage": 0 ' +
                '        }' +            
                '';

                integer intHeaderLength = body.length();
                req.setHeader('Content-Length', String.valueOf(intHeaderLength));
                req.setHeader('Content-Type', 'application/json');
                req.setHeader('accept', 'application/json');
                
                req.setBody(body);
            
//strReturnValue += ' 2 ';
//String zzz = req.getBody();
//strReturnValue += ' 2.5 ' + zzz;
    
            HttpResponse res = h.send(req);
            System.debug(res.getBody());
    
//strReturnValue += ' 3 ' + res.getBody();
            JSONParser parser = JSON.createParser(res.getBody());
            //NOTE:  if epicor is down, this is where it fails because parser is empty:
//strReturnValue += ' 4 ';
    
            while (parser.nextToken() != null) {
//strReturnValue += ' 5 ';
                if ((parser.getCurrentToken() == JSONToken.FIELD_NAME) && 
                    (parser.getText() == 'ListCode' || parser.getText() == 'CurrencyCode'
                     || parser.getText() == 'BasePrice' || parser.getText() == 'BreakPrice'
                     || parser.getText() == 'NetPrice' || parser.getText() == 'Quantity'
                     || parser.getText() == 'zz')) 
                {
                    string fieldName = parser.getText();

//strReturnValue += ' 6 ' + parser.getText();
                    
                    parser.nextToken();
                    
                    //original trial returning one value
                    //url_result = parser.getText();

//strReturnValue += ' 7 ' + parser.getText();
                    
                    string fieldValue; 
                    if(fieldName == 'Calculated_OnHand'
                       || fieldName == 'Calculated_Allocated' || fieldName == 'Calculated_Demand'
                       || fieldName == 'Calculated_Available')
                    {
                        //fieldValue = String.valueOf(decimal.valueOf(parser.getText()));
                        fieldValue = currency(parser.getText());
                    }
                    else
                    {
                        fieldValue = parser.getText();
                    }
                    
                    epicorPricingData.put(fieldName, fieldValue);
 
                    //KEEP: for debugging, to add debug log info
                    //System.debug('url_result: ' + url_result );
                    
                    epicorPricingData.put('Epicor_Status', 'OK');
                    
                }
            }
        } catch (DmlException de) {
            epicorPricingData.put('Epicor_Status', 'Epicor Error: ' + de );
        }
        catch (Exception e) {
            epicorPricingData.put('Epicor_Status', 'Epicor Error: ' + e );
        }

		//strReturnValue += ' /ListCode ' + epicorPricingData.get('ListCode');
        //return strReturnValue;
        return epicorPricingData;

    }


    public static String currency(String i) {
        // - Error this doesn't handle negative number converts -15 to -14.999  instead of -15.001 before round
        //String s = ( Decimal.valueOf(i==null||i.trim()==''?'0':i).setScale(2) + 0.001 ).format();
        //return s.substring(0,s.length()-1);
    
        if (( i == null) || ( i == ''))
        {
            return '0';
        }
        else
        {
            string s;
            if ( Decimal.valueOf(i) >= 0 )
            {
                s =  ( Decimal.valueOf(i).setScale(2) + 0.001 ).format();
            }
            else
            {
                s = ( Decimal.valueOf(i).setScale(2) - 0.001 ).format();
            }
	        return s.substring(0,s.length()-1);
        }
    
    }
    
}

